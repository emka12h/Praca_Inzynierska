@model IEnumerable<GlamStudio.Areas.Salon.Models.ServiceStatisticViewModel>

@{
    ViewData["Title"] = "Raport Usług";
    Layout = "~/Areas/Salon/Views/Shared/_Layout.cshtml";


    var labels = Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => x.ServiceName));
    var dataCounts = Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => x.TotalAppointments));
    var dataRevenue = Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => x.TotalRevenue));
}

<style>



    .chart-container {
        position: relative;
        height: 350px;
        width: 100%;
    }


    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }


    .text-glam {
        color: #C5A09A;
    }


    @@media (max-width: 767.98px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
            margin-top: 1rem !important;
        }

        h2 {
            font-size: 1.6rem;
            margin-bottom: 1.5rem !important;
            text-align: center;
        }

        .summary-card-col {
            margin-bottom: 1rem;
        }

        .card-body h2 {
            font-size: 1.8rem;
        }


        .chart-container {
            height: 250px;
        }


        .mobile-table thead {
            display: none;
        }

        .mobile-table tbody tr {
            display: block;
            margin-bottom: 1rem;
            background-color: #fff;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            padding: 15px;
        }

        .mobile-table tbody td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border: none;
            border-bottom: 1px solid #f8f9fa;
            text-align: right;
        }

            .mobile-table tbody td:last-child {
                border-bottom: none;
            }

            .mobile-table tbody td::before {
                content: attr(data-label);
                font-weight: 700;
                color: #6c757d;
                font-size: 0.85rem;
                text-transform: uppercase;
                text-align: left;
                margin-right: 15px;
            }

        .td-service-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            display: block;
            text-align: left !important;
            margin-bottom: 5px;
            border-bottom: 2px solid #E8C2C6 !important;
            padding-bottom: 10px !important;
        }

            .td-service-name::before {
                display: none;
            }
    }
</style>

<div class="container pb-5">

    <div class="row justify-content-center">
        <div class="col-12 col-xl-10 col-xxl-9">

            <h2 class="mb-4 text-secondary">Raport Usług</h2>

            <div class="row mb-4 g-3">
                <div class="col-md-4 summary-card-col">
                    <div class="card bg-white border shadow-sm h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h6 class="text-muted text-uppercase small ls-1 mb-2">Całkowity Przychód</h6>
                            <h2 class="text-success fw-bold mb-0">@Model.Sum(x => x.TotalRevenue).ToString("C0")</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 summary-card-col">
                    <div class="card bg-white border shadow-sm h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h6 class="text-muted text-uppercase small ls-1 mb-2">Liczba Wizyt</h6>
                            <h2 class="text-dark fw-bold mb-0">@Model.Sum(x => x.TotalAppointments)</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 summary-card-col">
                    <div class="card bg-white border shadow-sm h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h6 class="text-muted text-uppercase small ls-1 mb-2">Top Usługa</h6>
                            <h4 class="text-primary fw-bold mb-0 text-truncate w-100" style="color: #0d6efd;">
                                @(Model.FirstOrDefault()?.ServiceName ?? "Brak")
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-5 rounded-3 border">
                <div class="card-header fw-bold text-secondary">
                    <i class="fas fa-chart-bar me-2"></i> Wizualizacja Sprzedaży
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="servicesChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border border-0">
                <div class="card-header fw-bold d-none d-md-block bg-dark text-white rounded-top">
                    <div class="row px-2">
                        <div class="col-4">Usługa</div>
                        <div class="col-3">Kategoria</div>
                        <div class="col-2 text-center">Liczba Wizyt</div>
                        <div class="col-3 text-end">Przychód</div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="d-none d-md-block">
                        @foreach (var item in Model)
                        {
                            <div class="row border-bottom py-3 mx-0 px-2 align-items-center hover-bg-light">
                                <div class="col-4 fw-bold text-dark">@item.ServiceName</div>
                                <div class="col-3"><span class="badge bg-secondary rounded-pill">@item.Category</span></div>
                                <div class="col-2 text-center fw-bold">@item.TotalAppointments</div>
                                <div class="col-3 text-end text-success fw-bold">@item.TotalRevenue.ToString("C")</div>
                            </div>
                        }
                    </div>

                    <table class="table table-striped table-hover mb-0 mobile-table d-md-none">
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="td-service-name" data-label="Usługa">@item.ServiceName</td>
                                    <td data-label="Kategoria">
                                        <span class="badge bg-secondary rounded-pill">@item.Category</span>
                                    </td>
                                    <td data-label="Liczba wizyt" class="text-center">
                                        <span class="fw-bold">@item.TotalAppointments</span>
                                    </td>
                                    <td data-label="Przychód" class="text-end">
                                        <span class="text-success fw-bold">@item.TotalRevenue.ToString("C")</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        var ctx = document.getElementById('servicesChart').getContext('2d');

        var serviceLabels = @Html.Raw(labels);
        var revenueData = @Html.Raw(dataRevenue);
        var countData = @Html.Raw(dataCounts);

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: serviceLabels,
                datasets: [
                    {
                        label: 'Przychód (PLN)',
                        data: revenueData,
                        backgroundColor: 'rgba(197, 160, 154, 0.7)',
                        borderColor: 'rgba(197, 160, 154, 1)',
                        borderWidth: 1,
                        yAxisID: 'y',
                        borderRadius: 4,
                        barPercentage: 0.6
                    },
                    {
                        label: 'Liczba Wizyt',
                        data: countData,
                        backgroundColor: 'rgba(108, 117, 125, 0.7)',
                        borderColor: 'rgba(108, 117, 125, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        borderRadius: 4,
                        barPercentage: 0.6,
                        hidden: window.innerWidth < 768
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, boxWidth: 8 }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: window.innerWidth >= 768, text: 'Przychód (PLN)' },
                        ticks: { callback: function(value) { return value + ' zł'; } }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: window.innerWidth >= 768, text: 'Ilość' },
                        grid: { drawOnChartArea: false }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: { size: 11 }
                        },
                        grid: { display: false }
                    }
                }
            }
        });
    </script>
}