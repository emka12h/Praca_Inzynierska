@model IEnumerable<GlamStudio.Models.Message>
@{
    ViewData["Title"] = "Moje wiadomości";
}

<style>
    .btn-glam-pink {
        background-color: #E8C2C6;
        color: #4D4C4A;
        border: none;
        font-weight: 600;
        transition: 0.3s ease;
        padding: 10px 20px;
    }

        .btn-glam-pink:hover {
            background-color: #d4a6ab;
            color: #222;
        }

    .accordion-item {
        border: none;
        border-radius: 12px !important;
        margin-bottom: 1rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .accordion-button {
        background-color: #fff;
        color: #4D4C4A;
        font-weight: 600;
        border-radius: 12px !important;
    }

        .accordion-button:not(.collapsed) {
            background-color: #fcf5f4;
            color: #4D4C4A;
            box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
        }

        .accordion-button:focus {
            border-color: #E8C2C6;
            box-shadow: 0 0 0 0.25rem rgba(232, 194, 198, 0.25);
        }

    .message-bubble {
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        position: relative;
    }

    .bubble-client {
        background-color: #f8f9fa;
        border-left: 4px solid #adb5bd;
    }

    .bubble-history {
        background-color: #fff;
        border: 1px solid #e9ecef;
    }

    @@media (max-width: 767.98px) {
        .container {
            padding-top: 1rem;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 0.5rem;
        }

        .header-desc {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        .accordion-button {
            padding: 1rem;
            align-items: flex-start;
        }

        .accordion-header-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        .msg-date {
            font-size: 0.85rem;
            color: #888;
        }

        .reply-area {
            font-size: 16px;
            border-radius: 10px;
        }

        .btn-reply-mobile {
            width: 100%;
            margin-top: 10px;
        }

        .badge {
            align-self: flex-start;
            margin-bottom: 4px;
        }
    }
</style>

<div class="container pb-5">
    <h1 class="text-secondary">@ViewData["Title"]</h1>
    <p class="header-desc">Historia Twoich zapytań i konwersacji z salonem.</p>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm rounded-3" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm rounded-3" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!Model.Any())
    {
        <div class="alert alert-light border text-center py-5 rounded-3 shadow-sm">
            <div class="mb-3 text-muted display-6"><i class="far fa-comments"></i></div>
            <p class="mb-3 fw-bold text-muted">Nie wysłałeś jeszcze żadnych wiadomości.</p>
            <a asp-controller="Home" asp-action="Contact" class="btn btn-glam-pink shadow-sm">
                Napisz do nas
            </a>
        </div>
    }

    <div class="accordion" id="messagesAccordion">
        @foreach (var item in Model)
        {
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-@item.MessageId">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@item.MessageId" aria-expanded="false">
                        <div class="accordion-header-content">
                            <div>
                                @if (item.IsReadByClient)
                                {
                                    <span class="badge bg-secondary rounded-pill px-3">Przeczytano</span>
                                }
                                else
                                {
                                    <span class="badge bg-success rounded-pill px-3">Nowa odpowiedź</span>
                                }
                            </div>
                            <span class="msg-date">
                                <i class="far fa-clock me-1"></i> Wysłano: @item.DateSent.ToString("dd.MM.yyyy, HH:mm")
                            </span>
                        </div>
                    </button>
                </h2>
                <div id="collapse-@item.MessageId" class="accordion-collapse collapse" data-bs-parent="#messagesAccordion">
                    <div class="accordion-body bg-light">

                        <div class="message-bubble bubble-client shadow-sm bg-white">
                            <div class="d-flex align-items-center mb-2 text-muted small text-uppercase fw-bold">
                                <i class="fas fa-user me-2"></i> Twoje pytanie
                            </div>
                            <p class="mb-0" style="white-space: pre-wrap; color: #333;">@item.Contents</p>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(item.ReplyContent))
                        {
                            <div class="message-bubble bubble-history shadow-sm">
                                <div class="d-flex align-items-center mb-2 text-primary small text-uppercase fw-bold">
                                    <i class="fas fa-history me-2"></i> Historia rozmowy
                                </div>
                                <div class="p-3 bg-light rounded-3 border">
                                    <p class="mb-0 small text-dark" style="white-space: pre-wrap; line-height: 1.6;">@item.ReplyContent</p>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-3 text-muted fst-italic">
                                <i class="fas fa-hourglass-half me-1"></i> Oczekuje na odpowiedź personelu.
                            </div>
                        }

                        <div class="mt-4 pt-3 border-top">
                            <form asp-action="SubmitClientReply" method="post">
                                <input type="hidden" name="messageId" value="@item.MessageId" />
                                @Html.AntiForgeryToken()

                                <div class="mb-2">
                                    <label for="clientReply-@item.MessageId" class="form-label fw-bold small text-muted">
                                        <i class="fas fa-reply me-1"></i> Napisz odpowiedź:
                                    </label>
                                    <textarea name="clientReply" id="clientReply-@item.MessageId" class="form-control reply-area shadow-sm" rows="3" placeholder="Wpisz treść wiadomości..."></textarea>
                                </div>
                                <div class="text-end text-md-start">
                                    <button type="submit" class="btn btn-glam-pink btn-reply-mobile shadow-sm">
                                        Wyślij odpowiedź
                                    </button>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>
</div>